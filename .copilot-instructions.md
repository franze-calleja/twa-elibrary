# GitHub Copilot Instructions - TWA E-Library System

> This file provides context to GitHub Copilot for AI-assisted development.

## Project Overview
University e-library management system with barcode scanning for book tracking, student management, and borrowing operations.

## Tech Stack
- **Framework**: Next.js 15+ (App Router, TypeScript)
- **Database**: MySQL with Prisma ORM
- **UI**: Shadcn UI + Tailwind CSS
- **State**: Zustand (global) + TanStack Query (server)
- **Auth**: JWT-based authentication
- **Hosting**: Vercel (app) + TiDB Cloud (database)

## User Roles
1. **Staff**: Manage books, students, transactions, and system settings
2. **Students**: Browse books, borrow via barcode scanning, view history

## Code Standards

### TypeScript
- **Always use strict types** - no `any`, use `unknown` or proper types
- Leverage Prisma-generated types
- Define interfaces for all data structures

```typescript
// ✅ Good
interface BookFormData {
  title: string
  author: string
  isbn?: string
}

// ❌ Bad
const data: any = {...}
```

### Next.js Patterns
- **Server Components by default** - add `'use client'` only when needed
- Use Server Actions for mutations when appropriate
- Implement loading.tsx and error.tsx for routes

```typescript
// Server Component (default)
export default async function BooksPage() {
  const books = await prisma.book.findMany()
  return <BookList books={books} />
}

// Client Component (when needed)
'use client'
export function BookScanner() {
  const [scanning, setScanning] = useState(false)
  // ... browser APIs
}
```

### API Routes
- Use consistent response format
- Validate with Zod
- Proper error handling
- Authentication middleware

```typescript
import { NextResponse } from 'next/server'

export async function GET() {
  try {
    const data = await fetchData()
    return NextResponse.json({ success: true, data })
  } catch (error) {
    return NextResponse.json(
      { success: false, error: { code: 'ERROR_CODE', message: error.message } },
      { status: 500 }
    )
  }
}
```

### Database (Prisma)
- Always use transactions for multi-step operations
- Use `select` to limit returned fields
- Include related data with `include`

```typescript
await prisma.$transaction(async (tx) => {
  await tx.book.update({
    where: { id: bookId },
    data: { availableQuantity: { decrement: 1 } }
  })
  await tx.transaction.create({
    data: { bookId, userId, status: 'ACTIVE' }
  })
})
```

### Forms
- Use react-hook-form + Zod validation
- Show loading states during submission
- Handle success/error with toast notifications

```typescript
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'

const form = useForm<FormData>({
  resolver: zodResolver(schema)
})
```

### State Management
- **Zustand** for global state (auth, UI)
- **TanStack Query** for server state (data fetching)
- **React State** for local component state

```typescript
// Zustand store
export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  token: null,
  setAuth: (user, token) => set({ user, token }),
  logout: () => set({ user: null, token: null })
}))

// TanStack Query
export function useBooks() {
  return useQuery({
    queryKey: ['books'],
    queryFn: async () => {
      const res = await axios.get('/api/books')
      return res.data.data
    }
  })
}
```

### Components
- Small, focused components
- Proper TypeScript prop types
- Use Shadcn UI as base
- Follow accessibility best practices

```typescript
interface BookCardProps {
  book: Book
  onBorrow?: (bookId: string) => void
  showActions?: boolean
}

export function BookCard({ book, onBorrow, showActions = true }: BookCardProps) {
  return <Card>...</Card>
}
```

## File Paths
- Components: `@/components/...`
- Utilities: `@/lib/...`
- Hooks: `@/hooks/...`
- Types: `@/types/...`
- Store: `@/store/...`

## Common Patterns

### Error Handling
```typescript
try {
  // Operation
} catch (error) {
  if (error instanceof Prisma.PrismaClientKnownRequestError) {
    if (error.code === 'P2002') {
      return NextResponse.json(
        { success: false, error: { code: 'DUPLICATE', message: 'Record already exists' } },
        { status: 409 }
      )
    }
  }
  throw error
}
```

### Pagination
```typescript
const page = parseInt(params.page || '1')
const limit = parseInt(params.limit || '10')
const skip = (page - 1) * limit

const [data, total] = await Promise.all([
  prisma.model.findMany({ skip, take: limit }),
  prisma.model.count()
])

return {
  data,
  pagination: { page, limit, total, totalPages: Math.ceil(total / limit) }
}
```

### Date Calculations
```typescript
import { addDays, isPast, differenceInDays } from 'date-fns'

const dueDate = addDays(new Date(), 14)
const isOverdue = isPast(dueDate)
const daysOverdue = differenceInDays(new Date(), dueDate)
```

## Barcode Implementation
- **Generate**: Use CODE128 format with `bwip-js`
- **Scan**: Use `@zxing/browser` for camera scanning
- **Pattern**: `LIB-{YEAR}-{SEQUENCE}` (e.g., LIB-2026-00001)
- Support manual entry fallback

## Security
- Validate all user input
- Check authentication and authorization
- Sanitize data before display
- Use parameterized queries (Prisma)
- Store secrets in environment variables

## Performance
- Use React.memo for expensive renders
- Implement pagination for large lists
- Optimize images with Next.js Image
- Proper TanStack Query caching

## Key Business Rules

### Borrowing Eligibility
- Book must be AVAILABLE
- Student account must be ACTIVE
- Student within borrowing limit
- No overdue books
- No unpaid fines above threshold

### Due Date Calculation
```typescript
const dueDate = addDays(new Date(), loanPeriodDays)
```

### Fine Calculation
```typescript
const daysOverdue = differenceInDays(new Date(), dueDate)
const fineAmount = daysOverdue * finePerDay
```

### Renewal Rules
- Book not reserved by another student
- Maximum renewals not exceeded
- No overdue fines
- Requested before or on due date

## Documentation Reference
See `/twa-elibrary-documentation/` folder for:
- PROJECT_OVERVIEW.md
- DATABASE_SCHEMA.md
- API_SPECIFICATION.md
- FOLDER_STRUCTURE.md
- FEATURES_SPECIFICATION.md
- DEVELOPMENT_GUIDE.md
- GITHUB_COPILOT_INSTRUCTIONS.md (detailed version)

## Quick Commands
```bash
# Database
npx prisma migrate dev --name <name>
npx prisma generate
npx prisma studio

# Development
npm run dev

# Add Shadcn component
npx shadcn-ui@latest add <component>
```

## Remember
- Server Components by default
- Strict TypeScript
- Validate with Zod
- Consistent error handling
- Mobile-first responsive design
- Accessibility (WCAG 2.1)
- Comprehensive logging

For detailed guidelines, see `/twa-elibrary-documentation/GITHUB_COPILOT_INSTRUCTIONS.md`
